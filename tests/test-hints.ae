
#include "src/aesop/aesop.h"
#include "src/common/resources/timer/timer.hae"

__blocking void do_blocking3(void)
{
    triton_ret_t tret;
    int ret;
    int sleep;

    ret = aesop_hints_get("aesop.test.sleepy_time", sizeof(sleep), &sleep);
    assert(ret == 0);

    tret = triton_timer(sleep);
    triton_error_assert(tret);
}

__blocking void do_blocking2(void)
{
    pwait
    {
        pbranch
        {
            do_blocking3();
        }

        pbranch
        {
            do_blocking3();
        }
    }
}

__blocking void do_blocking1(void)
{
    int sleep = 1000;
    int ret;

    ret = aesop_hints_put("aesop.test.sleepy_time", sizeof(sleep), &sleep, 1);
    assert(ret == 0);

    do_blocking2();
}

__blocking int aesop_main(int argc, char **argv)
{
    ae_hints_type_register("aesop.test.sleepy_time", 0);

    do_blocking1();

    do_blocking3();

    return 0;
}
aesop_main_set_with_init(NULL, "timer", aesop_main, "timer");
